<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Herramienta de An√°lisis - Cronograf√≠as</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* ESTILOS BASE */
        html, body { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background-color: #ffffff !important; 
            overflow: hidden; color: #333; 
        }

        #main-wrapper {
            position: relative; width: 100%; height: 100vh;
            display: flex; flex-direction: column;
        }

        canvas { 
            display: block; width: 100%; height: 100%; 
            position: absolute; top: 0; left: 0; z-index: 0;
        }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none; 
        }

        /* HEADER */
        .header-container {
            width: 100%; display: flex; justify-content: center;
            padding-top: 10px; pointer-events: auto;
        }
        .title-box {
            text-align: center; background: rgba(255,255,255,0.85);
            padding: 5px 15px; border-radius: 15px; backdrop-filter: blur(2px);
        }
        .title-box h1 { margin: 0; font-size: 1.5rem; font-weight: 800; color: #2d3436; text-transform: uppercase; }
        .title-box h2 { margin: 0; font-size: 0.85rem; font-weight: 500; color: #636e72; }

        /* CONTROLES */
        .controls-area {
            position: absolute; top: 15px; left: 15px; display: flex; gap: 5px; pointer-events: auto;
        }
        .speed-btn {
            background: #f1f2f6; color: #636e72; border: 1px solid #ced6e0;
            padding: 6px 12px; border-radius: 15px; cursor: pointer; font-size: 0.75rem; font-weight: bold;
        }
        .speed-btn.active { background: #74b9ff; color: white; border-color: #74b9ff; }

        #clock {
            position: absolute; top: 15px; right: 15px;
            font-size: 1.8rem; font-weight: 800; background: rgba(255,255,255,0.9); color: #2d3436;
            padding: 2px 15px; border-radius: 12px; border: 1px solid #dfe6e9; pointer-events: auto;
        }

        /* FOOTER */
        .footer-info { position: absolute; bottom: 10px; left: 15px; pointer-events: auto; }
        .author-badge {
            background: rgba(255,255,255,0.9); border: 1px solid #dfe6e9;
            padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; color: #0984e3;
        }

        /* ETIQUETAS */
        .label {
            position: absolute; font-size: 0.65rem; font-weight: bold; color: #636e72;
            border: 1px solid rgba(0,0,0,0.1); width: 85px; height: 55px; border-radius: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; 
            pointer-events: none; background: rgba(255,255,255,0.7); padding: 2px;
            transform: translate(-50%, -50%); transition: top 0.3s, left 0.3s; z-index: 5;
        }
        .pct-indicator { font-size: 0.8rem; color: #0984e3; margin-top: 1px; }
        .label.center-activity { 
            width: 100px; height: 100px; border-radius: 50%;
            border: 2px dashed #b2bec3; background: rgba(245, 245, 245, 0.5); font-size: 0.8rem; color: #2d3436;
        }
        .label.center-activity .pct-indicator { font-size: 1.1rem; font-weight: 800; }

        /* --- ESTILOS DE LA CAJA NEGRA (MODAL) --- */
        #data-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.98); z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .modal-content {
            background: #fff; padding: 20px; border-radius: 15px; width: 90%; max-width: 800px;
            text-align: center; border: 1px solid #eee; height: 70vh; display: flex; flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        textarea {
            width: 100%; flex-grow: 1; background: #f8f9fa; color: #2d3436; border: 1px solid #dfe6e9;
            padding: 10px; font-family: 'Consolas', monospace; margin-top: 10px; font-size: 0.75rem; border-radius: 5px;
            white-space: pre; overflow: auto;
        }
        button.start-btn {
            background: #74b9ff; color: white; border: none; padding: 12px 40px;
            font-size: 1.1rem; margin-top: 20px; cursor: pointer; border-radius: 50px;
            font-weight: bold; transition: all 0.2s; box-shadow: 0 4px 10px rgba(116, 185, 255, 0.4);
        }
        button.start-btn:hover { background: #0984e3; transform: scale(1.05); }

        /* Tooltip */
        #tooltip {
            position: absolute; display: none; background: rgba(255, 255, 255, 0.98);
            border: 1px solid #dfe6e9; color: #2d3436; padding: 10px;
            border-radius: 8px; pointer-events: none; z-index: 1000; font-size: 0.85rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15); left: 50%; top: 50%; transform: translate(-50%, -50%);
        }

        @media (max-width: 768px) {
            .title-box h1 { font-size: 1rem; } .title-box h2 { display: none; } 
            #clock { font-size: 1.2rem; top: 50px; right: 50%; transform: translateX(50%); background: rgba(255,255,255,0.6); }
            .controls-area { top: 50px; left: 10px; transform: scale(0.8); transform-origin: left top; }
            .label { width: 60px; height: 40px; font-size: 0.5rem; background: rgba(255,255,255,0.6); }
            .label.center-activity { width: 70px; height: 70px; font-size: 0.6rem; }
            .author-badge { font-size: 0.6rem; padding: 3px 8px; bottom: 5px; left: 5px;}
        }
    </style>
</head>
<body>

<div id="data-modal">
    <div class="modal-content">
        <h2 style="margin: 0 0 10px 0; color:#2d3436">üìä Carga de Datos</h2>
        <p style="color: #636e72; margin: 0 0 10px 0; font-size: 0.9rem;">
            Pega tu CSV aqu√≠ para visualizarlo.
        </p>
<textarea id="csv-input">
ID,Grupo,06:00,06:30,07:00,07:30,08:00,08:30,09:00,09:30,10:00,10:30,11:00,11:30,12:00,12:30,13:00,13:30,14:00,14:30,15:00,15:30,16:00,16:30,17:00,17:30,18:00,18:30,19:00,19:30,20:00,20:30,21:00,21:30,22:00,22:30,23:00
1,Economia,Dormir,Dormir,Cuidado personal,Traslado,Traslado,Clases en la facultad,Clases en la facultad,Clases en la facultad,Clases en la facultad,Tareas y estudio,Tareas y estudio,Comer y beber,Convivir con familia,Convivir con familia,Socializar,Clases en la facultad,Clases en la facultad,Clases en la facultad,Traslado,Traslado,Ejercicio y/o deporte,Ejercicio y/o deporte,Cuidado personal,Cuidado personal,Dormir,Dormir,Dormir,Dormir,Dormir,Dormir,Dormir,Dormir,Dormir,Dormir
2,Polacas,Dormir,Dormir,Dormir,Dormir,Cuidado personal,Traslado,Traslado,Trabajar,Trabajar,Trabajar,Trabajar,Trabajar,Traslado,Clases en la facultad,Clases en la facultad,Clases en la facultad,Comer y beber,Convivir con familia,Socializar,Socializar,Clases en la facultad,Clases en la facultad,Traslado,Tareas del hogar,Convivir con familia,Convivir con familia,Entretenimiento,Dormir,Dormir,Dormir,Dormir,Dormir,Dormir,Dormir,Dormir
3,Antropologia,Dormir,Dormir,Cuidado personal,Cuidado personal,Traslado,Clases en la facultad,Clases en la facultad,Clases en la facultad,Clases en la facultad,Socializar,Socializar,Comer y beber,Comer y beber,Clases extracurriculares,Clases extracurriculares,Tareas y estudio,Tareas y estudio,Entretenimiento,Entretenimiento,Traslado,Convivir con familia,Dormir,Dormir,Dormir,Dormir,Dormir,Dormir,Dormir,Dormir,Dormir,Dormir,Dormir,Dormir,Dormir
</textarea>
        <button class="start-btn" onclick="startSimulation()">‚ñ∂ Iniciar Visualizaci√≥n</button>
    </div>
</div>

<div id="main-wrapper">
    <div id="ui-layer">
        <div class="header-container">
            <div class="title-box">
                <h1>Cronograf√≠as Universitarias</h1>
                <h2>Visualizaci√≥n de patrones de uso del tiempo</h2>
            </div>
        </div>
        <div class="controls-area">
            <div id="speed-controls">
                <button class="speed-btn" onclick="setSpeed(200, this)">Lento</button>
                <button class="speed-btn active" onclick="setSpeed(60, this)">Medio</button>
                <button class="speed-btn" onclick="setSpeed(15, this)">R√°pido</button>
            </div>
        </div>
        <div id="clock">06:00</div>
        <div id="labels-container"></div> 
        <div class="footer-info">
            <div class="author-badge">Elaborado por: Adri√°n Eduardo Pech Quijano</div>
        </div>
    </div>
    <div id="tooltip"></div>
    <canvas id="simulation"></canvas>
</div>

<script>
    // --- MODO DEMO: Pon 'true' para multiplicar puntos x20 (si tienes pocos datos)
    // Pon 'false' para 1 a 1 (datos reales)
    const MODO_DEMO = true; 

    // --- CONFIGURACI√ìN ---
    const canvas = document.getElementById("simulation");
    const context = canvas.getContext("2d", { alpha: false });
    let width, height;

    function resizeCanvas() {
        width = window.innerWidth || document.documentElement.clientWidth;
        height = window.innerHeight || document.documentElement.clientHeight;
        canvas.width = width; canvas.height = height;
        createLabels(); 
    }
    window.addEventListener('resize', resizeCanvas);

    // --- MAPA DE ACTIVIDADES ---
    const centers = {
        "Traslado": { x: 0.50, y: 0.55 }, "Dormir": { x: 0.15, y: 0.25 },
        "Cuidado personal": { x: 0.32, y: 0.25 }, "Preparar alimentos": { x: 0.50, y: 0.25 },
        "Comer y beber": { x: 0.68, y: 0.25 }, "Tareas del hogar": { x: 0.85, y: 0.25 },
        "Socializar": { x: 0.10, y: 0.85 }, "Convivir con familia": { x: 0.26, y: 0.85 }, 
        "Entretenimiento": { x: 0.42, y: 0.85 }, "Ejercicio y/o deporte": { x: 0.58, y: 0.85 },
        "Clases extracurriculares": { x: 0.74, y: 0.85 }, "Otras actividades": { x: 0.90, y: 0.85 },
        "Pagar cuentas": { x: 0.10, y: 0.55 }, "Comprar comida": { x: 0.25, y: 0.55 },
        "Religi√≥n": { x: 0.15, y: 0.70 }, "Clases en la facultad": { x: 0.85, y: 0.45 },
        "Trabajar": { x: 0.75, y: 0.55 }, "Tareas y estudio": { x: 0.85, y: 0.68 }
    };

    function createLabels() {
        const container = document.getElementById('labels-container');
        if(!container) return; container.innerHTML = ''; 
        Object.keys(centers).forEach(key => {
            const div = document.createElement('div');
            div.className = 'label';
            if (key === "Traslado") div.classList.add("center-activity");
            div.style.left = (centers[key].x * width) + 'px';
            div.style.top = (centers[key].y * height) + 'px';
            const safeId = key.replace(/\s+/g, '-').toLowerCase();
            div.innerHTML = `<div>${key}</div><div id="pct-${safeId}" class="pct-indicator">0%</div>`;
            container.appendChild(div);
        });
    }

    let nodes = [];
    let simulation;
    let clockInterval; 
    let time = 360; 
    const pastelColors = ["#ff7675", "#74b9ff", "#55efc4", "#ffeaa7", "#a29bfe", "#fd79a8", "#fab1a0", "#81ecec"];
    const colorScale = d3.scaleOrdinal(pastelColors); 

    function parseCSV(csvText) {
        const lines = csvText.trim().split(/\r?\n/);
        const headers = lines[0].split(',').map(h => h.trim());
        const parsedNodes = [];
        const toMin = (t) => {
            if(!t) return 0;
            const parts = t.trim().split(':');
            if(parts.length < 2) return 0;
            return (parseInt(parts[0]) * 60) + parseInt(parts[1]);
        };
        const timeCols = headers.map((h, i) => ({ header: h, index: i })).filter(c => c.header.includes(":"));

        for (let i = 1; i < lines.length; i++) {
            if (!lines[i].trim()) continue;
            const row = lines[i].split(',');
            if (row.length < headers.length) continue;
            const id = row[0]; const grupo = row[1];
            let schedule = [];
            for (let j = 0; j < timeCols.length; j++) {
                const col = timeCols[j];
                const startTime = toMin(col.header);
                const endTime = startTime + 30; 
                let activity = "Dormir";
                if (row[col.index]) activity = row[col.index].trim();
                if (schedule.length > 0 && schedule[schedule.length - 1].act === activity) {
                    schedule[schedule.length - 1].until = endTime;
                } else {
                    schedule.push({ until: endTime, act: activity });
                }
            }
            if (schedule.length > 0 && schedule[schedule.length - 1].until < 1440) {
                 schedule.push({ until: 1440, act: "Dormir" });
            }
            parsedNodes.push({
                id: id, group: grupo, schedule: schedule,
                x: width / 2, y: height / 2,
                currentActivity: "Dormir",
                targetX: centers["Dormir"].x * width, targetY: centers["Dormir"].y * height,
                color: colorScale(grupo) 
            });
        }
        return parsedNodes;
    }

    function startSimulation() {
        resizeCanvas();
        // AHORA LEE DEL TEXTAREA
        const csvInput = document.getElementById("csv-input").value;
        let data = parseCSV(csvInput);
        
        nodes = [];
        data.forEach(realNode => {
            const repeticiones = MODO_DEMO ? 20 : 1; 
            for(let i=0; i<repeticiones; i++) {
                nodes.push({
                    ...realNode, 
                    id: realNode.id + "-clone-" + i, 
                    x: (width/2) + (Math.random()*20 - 10), 
                    y: (height/2) + (Math.random()*20 - 10),
                    schedule: MODO_DEMO ? realNode.schedule.map(s => ({...s, until: s.until + (Math.random()*10 - 5)})) : realNode.schedule
                });
            }
        });

        // Ocultar Modal
        document.getElementById("data-modal").style.display = "none";

        const isMobile = width < 768;
        simulation = d3.forceSimulation(nodes)
            .alphaMin(0.001).velocityDecay(0.35) 
            .force("charge", d3.forceManyBody().strength(isMobile ? -5 : -10)) 
            .force("collide", d3.forceCollide().radius(isMobile ? 3 : 5).strength(0.8)) 
            .on("tick", render);
        startClock(60); 
    }

    function render() {
        context.fillStyle = "rgba(255, 255, 255, 0.25)"; 
        context.fillRect(0, 0, width, height);

        // --- INICIO L√ìGICA DE PUNTOS INTELIGENTES ---
        let baseSize = 6; 
        const count = nodes.length;

        // Reglas de ajuste: M√°s gente = Puntos m√°s chicos
        if (count > 50) baseSize = 5;
        if (count > 150) baseSize = 4;
        if (count > 400) baseSize = 3;
        if (count > 800) baseSize = 2;

        const isMobile = width < 768;
        // Calcula el radio final para usarlo en todos los puntos
        const finalRadius = isMobile ? Math.max(2, baseSize - 1.5) : baseSize;
        // --- FIN L√ìGICA DE PUNTOS INTELIGENTES ---

        let hoveredNode = null;
        nodes.forEach(node => {
            node.x += (node.targetX - node.x) * 0.06;
            node.y += (node.targetY - node.y) * 0.06;
            
            context.beginPath(); 
            // Usamos finalRadius en lugar del n√∫mero fijo
            context.arc(node.x, node.y, finalRadius, 0, 2 * Math.PI);
            context.fillStyle = node.color; context.fill();
            
            if (mousePos) {
                const dist = Math.hypot(mousePos.x - node.x, mousePos.y - node.y);
                if (dist < 10) hoveredNode = node;
            }
        });
        const tooltip = document.getElementById("tooltip");
        if (hoveredNode && mousePos) {
            tooltip.style.display = "block";
            tooltip.style.left = (hoveredNode.x + 15) + "px"; tooltip.style.top = (hoveredNode.y - 15) + "px";
            tooltip.innerHTML = `<strong style="color:#74b9ff">${hoveredNode.group}</strong><br>${hoveredNode.currentActivity}`;
            context.beginPath(); context.arc(hoveredNode.x, hoveredNode.y, 8, 0, 2 * Math.PI);
            context.strokeStyle = "#2d3436"; context.lineWidth = 2; context.stroke();
        } else { tooltip.style.display = "none"; }
    }

    function updatePercentages() {
        const counts = {};
        Object.keys(centers).forEach(key => counts[key] = 0);
        counts["Otras actividades"] = 0; 
        nodes.forEach(node => {
            if (counts[node.currentActivity] !== undefined) {
                counts[node.currentActivity]++;
            } else {
                counts["Otras actividades"]++;
            }
        });
        const total = nodes.length;
        Object.keys(centers).forEach(key => {
            const safeId = key.replace(/\s+/g, '-').toLowerCase();
            const el = document.getElementById(`pct-${safeId}`);
            if (el) {
                const count = counts[key] || 0;
                const percent = total > 0 ? ((count / total) * 100).toFixed(0) : 0;
                el.innerText = percent + "%";
                el.style.color = count > 0 ? "#0984e3" : "#b2bec3";
            }
        });
    }

    function startClock(delay) {
        if (clockInterval) clearInterval(clockInterval);
        const clockDiv = document.getElementById("clock");
        clockInterval = setInterval(() => {
            time += 5; if (time >= 1440) time = 0;
            let hours = Math.floor(time / 60); let mins = time % 60;
            clockDiv.innerText = `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
            nodes.forEach(node => {
                const task = node.schedule.find(t => time < t.until);
                if (task) {
                    node.currentActivity = task.act;
                    if(centers[task.act]) {
                        node.targetX = centers[task.act].x * width; node.targetY = centers[task.act].y * height;
                    } else {
                        node.targetX = centers["Otras actividades"].x * width; node.targetY = centers["Otras actividades"].y * height;
                    }
                }
            });
            updatePercentages();
            simulation.alpha(0.15).restart();
        }, delay);
    }

    function setSpeed(delay, btnElement) {
        document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
        btnElement.classList.add('active');
        startClock(delay);
    }

    let mousePos = null;
    canvas.addEventListener("mousemove", e => {
        const rect = canvas.getBoundingClientRect();
        mousePos = { x: e.clientX - rect.left, y: e.clientY - rect.top };
    });
    canvas.addEventListener("mouseleave", () => mousePos = null);
    canvas.addEventListener("touchstart", e => {
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        mousePos = { x: touch.clientX - rect.left, y: touch.clientY - rect.top };
        setTimeout(() => mousePos = null, 2000);
    }, {passive: true});

    // En esta versi√≥n NO hay auto-arranque, esperamos el click del bot√≥n
</script>
</body>
</html>
